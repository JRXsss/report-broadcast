# .github/workflows/pipeline.yml
name: Report Pipeline (Refresh -> Broadcast)

on:
  workflow_dispatch:
    inputs:
      report_mode:
        description: "daily / daily_weekly / weekly / monthly"
        required: true
        default: "daily"
        type: choice
        options:
          - daily
          - daily_weekly
          - weekly
          - monthly

jobs:
  refresh:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install deps
        run: |
          pip install -r requirements.txt
      - name: Refresh base tables
        env:
          TZ: Asia/Shanghai
          MYSQL_HOST: ${{ secrets.MYSQL_HOST }}
          MYSQL_PORT: ${{ secrets.MYSQL_PORT }}
          MYSQL_USER: ${{ secrets.MYSQL_USER }}
          MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
          MYSQL_DB: ${{ secrets.MYSQL_DB }}
        run: |
          python -m src.run_refresh

  report:
    runs-on: ubuntu-latest
    needs: refresh
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install deps
        run: |
          pip install -r requirements.txt
      - name: Run report broadcast
        env:
          TZ: Asia/Shanghai
          MYSQL_HOST: ${{ secrets.MYSQL_HOST }}
          MYSQL_PORT: ${{ secrets.MYSQL_PORT }}
          MYSQL_USER: ${{ secrets.MYSQL_USER }}
          MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
          MYSQL_DB: ${{ secrets.MYSQL_DB }}
          WECOM_WEBHOOK_URL: ${{ secrets.WECOM_WEBHOOK_URL }}
        run: |
          python -m src.run_report --mode "${{ github.event.inputs.report_mode }}"
